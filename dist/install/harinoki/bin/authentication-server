#!/bin/bash -e

_SCRIPTS_DIR=$(cd "$(dirname $0)" && pwd)

export JETTY_HOME=${_SCRIPTS_DIR}/../lib/jetty
export JETTY_BASE=${_SCRIPTS_DIR}/../var/auth
if [ "${TSURUGI_AUTH_STOP_PORT}" = "" ]; then
  export TSURUGI_AUTH_STOP_PORT="19876"
fi
if [ "${TSURUGI_AUTH_STOP_KEY}" = "" ]; then
  export TSURUGI_AUTH_STOP_KEY="tsurugi-auth-server"
fi

function validate_env_harinoki_properties() {
    if [[ -n "${HARINOKI_PROPERTIES}" ]]; then
        props_file="${HARINOKI_PROPERTIES}"
        # If relative path, treat as absolute path from root
        if [[ "${props_file}" != /* ]]; then
            props_file="/${props_file}"
        fi
    else
        if [[ -z "${TSURUGI_HOME}" ]]; then
            echo "Error: both HARINOKI_PROPERTIES and TSURUGI_HOME are not set" >&2
            exit 1
        fi
        props_file="${TSURUGI_HOME%/}/var/auth/etc/harinoki.properties"
    fi

    if [[ ! -f "${props_file}" ]]; then
        echo "Error: harinoki.properties file not found: ${props_file}" >&2
        exit 1
    fi
}

function start_server() {
    validate_env_harinoki_properties

    echo start_server
    cd ${JETTY_BASE} && java -jar $JETTY_HOME/start.jar \
      jetty.home=${JETTY_HOME} \
      jetty.base=${JETTY_BASE} \
      stop.port=${TSURUGI_AUTH_STOP_PORT} \
      stop.key=${TSURUGI_AUTH_STOP_KEY} \
      ${JETTY_BASE}/etc/jaas-login-service.xml &
}

function stop_server() {
    echo stop_server
    java -jar $JETTY_HOME/start.jar --stop \
      jetty.home=${JETTY_HOME} \
      jetty.base=${JETTY_BASE} \
      stop.port=${TSURUGI_AUTH_STOP_PORT} \
      stop.key=${TSURUGI_AUTH_STOP_KEY}
}

case "$1" in
    start)   start_server ;;
    stop)    stop_server ;;
    restart) stop_server; start_server ;;
    *) echo "usage: $(basename $0) start|stop|restart" 1>&2
       exit 1
       ;;
esac
